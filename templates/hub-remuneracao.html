<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
    <link rel="stylesheet" href="static/style/styles.css">
    {% include "components/icon_title.html" %}
</head>

<body>

    {% include "components/header.html" %}

    {% include "components/sidebar.html" %}

    <div class="app-shell">
        <div class="sidebar-overlay"></div>

        <div class="main-content">
            <main class="main-container">
                <section class="welcome-section">
                    <h2>Remuneração</h2>
                    <p>Acompanhe indicadores e histórico por investidor.</p>
                </section>

                <!-- FILTROS REDESENHADOS -->
                <div class="filters">
                    <div class="search-box">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="remuSearchInput" placeholder="Buscar por investidor..."
                            onkeyup="filterInvestors()">
                    </div>

                    <div class="filter-group">
                        <div class="filter-item">
                            <i class="fa-solid fa-sitemap"></i>
                            <select id="squadFilter" onchange="filterInvestors()">
                                <option value="">Todas as Squads</option>
                                {% for squad in squads %}
                                <option value="{{ squad|lower }}">{{ squad }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-item">
                            <i class="fa-solid fa-user-tag"></i>
                            <select id="roleFilter" onchange="filterInvestors()">
                                <option value="">Todos os Cargos</option>
                                {% for role in roles %}
                                <option value="{{ role|lower }}">{{ role }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Grid de Investidores -->
                <div class="projects-grid" id="investorsGrid">
                    {% if investors %}
                    {% for inv in investors %}
                    <div class="project-card" data-id="{{ inv.id }}" data-name="{{ inv.name }}"
                        data-role="{{ inv.role }}" data-squad="{{ inv.squad }}" data-step="{{ inv.step }}"
                        data-yellow-flag="{{ inv.rows[0].yellow_streak if inv.rows|length > 0 else '' }}" data-green-flag="{{ inv.rows[0].green_streak if inv.rows|length > 0 else '' }}"
                        data-clients="{{ inv.clients_count }}" data-fixed="{{ inv.fixed_fee }}" data-mrr="{{ inv.mrr }}"
                        data-roi="{{ inv.roi }}" onclick="openRemunerationModal(this)">
                        <div class="project-header">
                            <div class="project-icon">
                                <i class="fa-solid fa-user-tie"></i>
                            </div>
                            {% if inv.rows | length > 0 %}

                            <span class='project-status {{
                                "yellow-flag" if inv.rows[-1].yellow_streak == 1
                                else "red-flag" if inv.rows[-1].yellow_streak == 2
                                else "black-flag" if inv.rows[-1].yellow_streak >= 3
                                else "green-pdc-flag" if inv.rows[-1].green_streak >= 3
                                else "green-flag"
                            }}'>

                            {{
                                "Yellow" if inv.rows[-1].yellow_streak == 1
                                else "Red" if inv.rows[-1].yellow_streak == 2
                                else "Black" if inv.rows[-1].yellow_streak >= 3
                                else "Green PDC" if inv.rows[-1].green_streak >= 3
                                else "Green"
                            }}
                            </span>

                            {% endif %}

                            
                        </div>
                        <h3 class="project-title">{{ inv.name }}</h3>
                        <p class="project-description">
                            <strong>Cargo:</strong> {{ inv.role }} | <strong>Squad:</strong> {{ inv.squad }}
                        </p>
                        <div class="project-meta">
                            <span>
                                <i class="fa-solid fa-users"></i>
                                {{ inv.clients_count }} Clientes
                            </span>
                        </div>

                        <!-- Template de dados da tabela -->
                        <template id="tmpl-{{ inv.id }}">
                            {% if inv.rows %}
                            {% for row in inv.rows %}
                            <tr>
                                <!-- FLAG -->
                                <td class='{{
                                    "yellow-flag-table" if row.yellow_streak == 1
                                    else "red-flag-table" if row.yellow_streak == 2
                                    else "black-flag-table" if row.yellow_streak >= 3
                                    else "green-pdc-flag-table" if row.green_streak >= 3
                                    else "green-flag-table"
                                }}'>
                                <span>
                                    {{
                                        "Yellow" if row.yellow_streak == 1
                                        else "Red" if row.yellow_streak == 2
                                        else "Black" if row.yellow_streak >= 3
                                        else "Green PDC" if row.green_streak >= 3
                                        else "Green"
                                    }}
                                </span>
                                </td>
                                <!-- MÊS/ANO -->
                                <td>{{ row.month_year }}</td>
                                <!-- CARGO -->
                                <td>{{ inv.role }}</td>
                                <!-- SENIORIDADE -->
                                <td>{{ inv.senioridade }}</td>
                                <!-- Nivel -->
                                <td>{{ inv.nivel }}</td>
                                <!-- REMUNERAÇÃO -->
                                <td><span class="monetario">R$ {{ inv.fixed_fee | round(2) }}</span></td>
                                <!-- MRR -->
                                <td><span class="monetario">R$ {{ row.mrr | round(2) }}</span></td>
                                <!-- CHURN R$ -->
                                <td><span class="monetario">RS {{ row.churn_rs | round(2) }}</span></td>
                                <!-- CHURN % -->
                                <td class="{{ 'remu-value-negative' if row.churn > 0 else '' }}">
                                    {% if row.churn is number %}
                                    {{ (row.churn * 100) | round(2) }}%
                                    {% else %}
                                    {{ row.churn }}
                                    {% endif %}
                                </td>
                                <!-- VARIAVEL R$ -->
                                <td><span class="monetario">R$ {{ row.variable_brl | round(2) }}</span></td>
                                <!-- REMUNERAÇÃO TOTAL -->
                                <td style="font-weight: 600;">R$ {{ row.total_brl | round(2) }}</span></td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">
                                    Nenhum registro encontrado.
                                </td>
                            </tr>
                            {% endif %}
                        </template>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fa-solid fa-inbox"></i>
                        <h3>Nenhum investidor encontrado</h3>
                        <p>Não há dados de remuneração disponíveis no momento.</p>
                    </div>
                    {% endif %}
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL DE DETALHES DE REMUNERAÇÃO -->
    <div id="remunerationModal" class="modal">
        <div class="modal-content modal-remu">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes de Remuneração</h2>
                <button class="close-btn" onclick="closeRemunerationModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="modal-body">
                <!-- Card de Identificação no Modal -->
                <section class="remu-investor-card">
                    <div class="remu-investor-info">
                        <span class="remu-investor-name" id="modalName">...</span>
                        <span class="remu-divider">|</span>
                        <span class="remu-investor-meta" id="modalRoleSquad">...</span>
                    </div>
                    <!-- <div class="remu-step-tag" id="modalStep">
                        Step: ...
                    </div> -->
                </section>

                <!-- Mini Cards de Métricas -->
                <div class="remu-metrics">
                    <div class="remu-metric-card">
                        <span class="remu-metric-label">Clientes</span>
                        <span class="remu-metric-value" id="modalClients">0</span>
                    </div>
                    <div class="remu-metric-card">
                        <span class="remu-metric-label">Rem. Fixa</span>
                        <span class="remu-metric-value" id="modalFixed">R$ 0,00</span>
                    </div>
                    <div class="remu-metric-card">
                        <span class="remu-metric-label">MRR</span>
                        <span class="remu-metric-value" id="modalMRR">R$ 0,00</span>
                    </div>
                    <div class="remu-metric-card">
                        <span class="remu-metric-label">ROI Médio</span>
                        <span class="remu-metric-value" id="modalROI">0%</span>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="remu-table-card">
                    <div class="remu-table-header">
                        <h3>Histórico de Remuneração</h3>
                    </div>
                    <div class="remu-table-wrapper">
                        <table class="remu-table">
                            <thead>
                                <tr>
                                    <th scope="col">Flag</th>
                                    <th scope="col">Mês-Ano</th>
                                    <th scope="col">Cargo</th>
                                    <th scope="col">Senioridade</th>
                                    <th scope="col">Nivel</th>
                                    <th scope="col">Remuneração Cargo</th>
                                    <th scope="col">MRR</th>
                                    <th scope="col">Churn R$</th>
                                    <th scope="col">Churn %</th>
                                    <th scope="col">R$ Variável</th>
                                    <th scope="col">Remuneração Total</th>
                                </tr>
                            </thead>
                            <tbody id="modalTableBody">
                                <!-- Preenchido via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeRemunerationModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script src="static/js/app.js"></script>
    <script src="static/js/remuneracao.js"></script>
</body>

</html>